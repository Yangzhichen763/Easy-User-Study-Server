<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">User-Study User-Interface</title>

    <link rel="stylesheet" href="/css/cube.css">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/css/imageViewer.css">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 20px;
            background-color: #e9ecef;
        }
        h1 {
            color: #343a40;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            max-width: 1100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .image-box {
            margin: 10px;
            width: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 0;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .image-box img {
            max-width: 100%;
            border-radius: 5px;
        }
        .description {
            text-align: center;
            font-size: 14px;
            color: #495057;
            margin-top: 5px;
        }
        .image-row {
            display: flex;
            justify-content: center;
        }

        /* å¢å¼ºå›¾åƒçš„é¢æ¿æ ·å¼ */
        .panel {
            margin: 10px 10px;
            padding: 10px;
            background: #f8f9fa; /* é¢æ¿èƒŒæ™¯é¢œè‰² */
            border-radius: 5px;
            color: #495057;
            border: 1px solid #ced4da; /* æ·»åŠ è¾¹æ¡† */
        }
        .panel-title {
            text-align: center;
            color: #343a40; /* æ ‡é¢˜é¢œè‰² */
            margin-bottom: 10px; /* æ ‡é¢˜ä¸å†…å®¹çš„é—´è· */
            margin-top: 10px;
        }

        /* æ˜Ÿæ˜Ÿè¯„åˆ†æ»‘æ¡æ ·å¼ */
        .star-rating {
            display: flex;
            justify-content: center;
        }
        .star {
            font-size: 30px;
            cursor: pointer;
            color: #e4e4e4; /* é»˜è®¤æ˜Ÿæ˜Ÿé¢œè‰² */
            transition: color 0.1s ease; /* é€æ˜åº¦ */
        }
        .star.highlight {
            color: #ffcc00; /* é«˜äº®é¢œè‰²ä¸ºé‡‘è‰² */
        }

        /* before after image slider */
        .slider-container {
            position: relative;
            width: 180px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 0;
            border-radius: 5px;
            background-color: #f8f9fa;

            .img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-size: 180px 100%;
                display: flex;
                border-radius: 5px;
            }
            .background-img {
                background-image: none;
                border: 0;
            }
            .foreground-img {
                background-image: none;
                width: calc(50% - 2px);
                border: 0;
            }

            .slider {
                position: absolute;
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 100%;
                background: #f2f2f200;
                outline: none;
                margin: 0;
                transition: all 0.2s;
                display: flex;
                justify-content: center;
                align-items: center;

                &:hover {
                    background: #f2f2f200;
                }
            }

            .slider-button {
                pointer-events: none;
                position: absolute;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background-color: white;
                left: calc(50% - 12px);
                top: calc(50% - 12px);
                display: flex;
                justify-content: center;
                align-items: center;

                &:after {
                    content: "";
                    padding: 2px;
                    display: inline-block;
                    border: solid #5d5d5d;
                    border-width: 0 2px 2px 0;
                    transform: rotate(-45deg);
                }
                &:before {
                    content: "";
                    padding: 2px;
                    display: inline-block;
                    border: solid #5d5d5d;
                    border-width: 0 2px 2px 0;
                    transform: rotate(135deg);
                }
            }
        }
    </style>

    <script src="/js/cube.js"></script>
    <script src="/js/imageViewer.js"></script>
    <script>
        // å›¾åƒç‚¹å‡»çš„æ—¶å€™ï¼Œå°†å›¾åƒå˜ä¸ºå¯¹æ¯”å›¾åƒ
        function onImageClick(index) {
            const allImages = document.querySelectorAll('.image-box');

            // æ·»åŠ å’Œç§»é™¤å±æ€§ mark
            const marked_output = document.querySelectorAll('[mark="true"]');
            const output_before = document.getElementById(`output-${index}`)
            if (marked_output.length > 0 && `${index}` === marked_output[0].id.split('-')[1]) {
                marked_output.forEach(output => {
                    output.removeAttribute('mark');
                });
                for (let i = 1; i < allImages.length; i++) {
                    // è·å– allImages[i] ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„ src
                    if (i === index) {
                        continue;
                    }

                    const imageContainer = document.getElementById(`after-output-${i}`)
                    let imageSrc = imageContainer.style.backgroundImage.split('(')[1].split(')')[0];
                    // å»æ‰å¼•å·
                    imageSrc = imageSrc.replace(/"/g, '');
                    displayImage(`output-${i}`, imageSrc)
                }
                addImageTool(allImages.length - 1, index);
            }
            else if (marked_output.length === 0) {
                marked_output.forEach(image => {
                    image.removeAttribute('mark');
                });
                output_before.setAttribute('mark', `${true}`);

                const imageSrc_before = output_before.src;

                // å°†å›¾åƒæ›¿æ¢ä¸º before after image slider
                for (let i = 1; i < allImages.length; i++) {
                    if (i === index) {
                        continue;
                    }

                    const abImage = document.getElementById(`output-${i}`);
                    const abImageSrc = abImage.src;
                    displayBeforeAfterImage(`output-${i}`, imageSrc_before, abImageSrc);
                }

                adjustImageBoxSize();
            }

            // è°ƒæ•´å›¾åƒçš„ box å¤§å°
            function adjustImageBoxSize() {
                const allImages = document.querySelectorAll('.image-box');

                // è·å–å›¾åƒå¤§å°
                const image = document.getElementById(`input`);
                const imageWidth = image.width;
                const imageHeight = image.height;
                console.log(imageWidth, imageHeight)
                const imageBoxWidth = 180;
                const imageBoxHeight = parseInt(imageHeight) / parseInt(imageWidth) * imageBoxWidth + 40;

                // è°ƒæ•´å›¾åƒçš„ box å¤§å°
                for (let i = 1; i < allImages.length; i++) {
                    const abImage = document.getElementById(`output-${i}`);
                    const abImageBox = abImage.parentNode;
                    abImageBox.style.width = `${imageBoxWidth}px`;
                    abImageBox.style.height = `${imageBoxHeight}px`;

                    // å°†å›¾ç‰‡çš„å¤§å°å’Œå¯¹æ¯”å›¾ç‰‡çš„å¤§å°ç›¸å¯¹åº”
                    const slider_container = document.getElementById(`slider-container-${abImage.id}`);
                    if (slider_container) {
                        slider_container.style.width = `${imageWidth}px`;
                        slider_container.style.height = `${imageHeight}px`;
                    }
                }
            }
        }


        function confirmImage(group, id) {
            // å‘è¯·æ±‚ç»™åç«¯
            const imageData = {
                select_group: group,
                select_id: id
            };
            let formData = new FormData();
            for (let key in imageData) {
                formData.append(`${key}`, imageData[key]);
            }

            // è·å–å½“å‰ç½‘é¡µçš„ url å’Œ user_id
            const url = window.location.href;
            const urlParams = new URLSearchParams(url.split('?')[1]);
            const user_id = urlParams.get('user_id');

            requestAndUpdate(formData, user_id);
        }

        function replaceImages(nextId) {
            const inputBox = document.getElementById('input-box');
            const outputRow = document.getElementById('output-row');

            // ä»é“¾æ¥ http://10.133.2.38:8000/image_groups ä¸­è·å–å¯ç”¨çš„ç»„
            fetch('/image_groups')
                .then(response => response.json()) // è§£æä¸º JSON
                .then(data => {
                    // æ’é™¤ input å’Œ GT ç»„
                    const groups = data.groups;
                    let excludeGroups = [];
                    for (let i = 0; i < groups.length; i++) {
                        if (groups[i].includes('input') || groups[i].includes('GT')) {
                            continue;
                        }
                        excludeGroups.push(groups[i]);
                    }
                    const excludeNumber = excludeGroups.length;

                    // ç”Ÿæˆæ•°ç»„ [1, 2, ..., number]
                    let outputIndices = Array.from({length: excludeNumber}, (_, i) => i+1);
                    outputIndices = outputIndices.sort(() => 0.5 - Math.random());

                    // è¾“å…¥å›¾åƒçš„ id
                    inputBox.setAttribute('imageid', nextId)
                    inputBox.innerHTML = `
                        <img src="/image?group=input&id=${nextId}" alt="Input Image" id="input">
                        `;

                    // éå†è¾“å‡ºå›¾åƒçš„ id
                    outputRow.innerHTML = '';
                    for (let i = 0; i < excludeNumber; i++) {
                        const k = outputIndices[i];

                        const group = excludeGroups[k - 1];
                        const outputInnerContent_i = `
                            <div class="image-box" imagegroup="${group}" imageid="${nextId}">
                                <img src="/image?group=${group}&id=${nextId}" alt="å¢å¼ºå›¾åƒ${i + 1}" id="output-${i + 1}">
                                <div class="star-rating" id="star-rating-${i + 1}">
                                    <span class="star" onclick="setStarRating(${i + 1}, 1)">â˜…</span>
                                    <span class="star" onclick="setStarRating(${i + 1}, 2)">â˜…</span>
                                    <span class="star" onclick="setStarRating(${i + 1}, 3)">â˜…</span>
                                    <span class="star" onclick="setStarRating(${i + 1}, 4)">â˜…</span>
                                    <span class="star" onclick="setStarRating(${i + 1}, 5)">â˜…</span>
                                </div>
                            </div>
                        `;
                        outputRow.innerHTML += outputInnerContent_i;
                    }

                    addImageTool(excludeNumber, null, false);
                })
                .catch(error => {
                    alert(`æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯ï¼š${error}`);
                });
        }

        // æ·»åŠ å›¾ç‰‡æŸ¥çœ‹å’Œå¯¹æ¯”å·¥å…·
        function addImageTool(idCount, i_except=null, except_input=true) {
            // å›¾åƒæŸ¥çœ‹å·¥å…·ï¼ˆå³é”®ç‚¹å‡»è§¦å‘ï¼‰
            const images = [];
            if (!except_input) {
                images.push(document.getElementById('input'));
            }
            for (let i = 0; i < idCount; i++) {
                if (i + 1 === i_except)
                    continue;

                const outputImage = document.getElementById(`output-${i + 1}`);
                images.push(outputImage);
            }
            addImageViewerListener('click', images)

            // å›¾åƒå¯¹æ¯”å·¥å…·ï¼ˆå·¦é”®ç‚¹å‡»è§¦å‘ï¼‰
            for (let i = 0; i < idCount; i++) {
                if (i + 1 === i_except)
                    continue;

                const outputImage = document.getElementById(`output-${i + 1}`);
                outputImage.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    onImageClick(i + 1);
                });
            }
        }


        // è°ƒæ•´ mainContainer çš„å®½åº¦
        function updateMainContainer() {
            const mainContainer = document.getElementById('main-container');

            fetch('/image_groups')
                .then(response => response.json()) // è§£æä¸º JSON
                .then(data => {
                    // æ’é™¤ input å’Œ GT ç»„
                    const groups = data.groups;
                    let excludeGroups = [];
                    for (let i = 0; i < groups.length; i++) {
                        if (groups[i].includes('input') || groups[i].includes('GT')) {
                            continue;
                        }
                        excludeGroups.push(groups[i]);
                    }
                    const excludeNumber = excludeGroups.length;

                    // è·å– image-box çš„å®½åº¦å’Œ padding
                    const imageBox = mainContainer.querySelector('.image-box');
                    const imageBoxComputedStyle = getComputedStyle(imageBox);
                    const imageBoxWidth = parseInt(imageBoxComputedStyle.width);
                    const imageBoxMarginLeft = parseInt(imageBoxComputedStyle.marginLeft);
                    const imageBoxMarginRight = parseInt(imageBoxComputedStyle.marginRight);
                    const containerWidth = (imageBoxWidth + imageBoxMarginLeft + imageBoxMarginRight) * excludeNumber;

                    // è®¾ç½® mainContainer çš„å®½åº¦
                    mainContainer.style.maxWidth = `${containerWidth}px`;
                    mainContainer.style.width = `${containerWidth}px`;
                })
                .catch(() => {
                    alert('è·å– groups å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                });
        }

        // ä¿®æ”¹ç½‘é¡µæ ‡é¢˜
        function changeTitle(title) {
            // è·å–å½“å‰ç½‘é¡µçš„ url å’Œ user_id
            const url = window.location.href;
            const urlParams = new URLSearchParams(url.split('?')[1]);
            const user_id = urlParams.get('user_id');

            const interfaceTitle = document.getElementById('interface-title');
            interfaceTitle.innerHTML = title

            const pageTitle = document.getElementById('page-title');
            pageTitle.innerHTML = title
        }

        // æ˜Ÿæ˜Ÿè¯„åˆ†æ»‘æ¡
        function setStarRating(index, rating) {
            const starContainer = document.getElementById(`star-rating-${index}`)
            const stars = starContainer.querySelectorAll('.star');
            stars.forEach((star, i) => {
                if (i < rating) {
                    star.classList.add('highlight'); // é«˜äº®æ˜¾ç¤º
                } else {
                    star.classList.remove('highlight'); // ç§»é™¤é«˜äº®
                }
            });
        }

        // æ˜¾ç¤º before after image slider
        function displayBeforeAfterImage(outputId, beforeImageUrl, afterimageUrl) {
            const output = document.getElementById(outputId);
            const outputParent = output.parentNode;
            // ä¿ç•™é™¤ id={outputId} å…ƒç´ ä»¥å¤–çš„æ‰€æœ‰å­å…ƒç´ 
            const children = Array.from(outputParent.children).filter(child => child.id!== outputId);
            // ç¼–è¾‘ output å…ƒç´ 
            outputParent.innerHTML = `
            <div class='center' id="${outputId}">
                <div class='slider-container' id="slider-container-${outputId}">
                    <div class='img background-img' style="background-image: url(${afterimageUrl})" id="after-${outputId}" urlcontent="${afterimageUrl}"></div>
                    <div class='img foreground-img' style="background-image: url(${beforeImageUrl})" id="before-${outputId}" urlcontent="${beforeImageUrl}"></div>
                    <input type="range" min="1" max="100" value="50" class="slider" name='slider' id="slider-${outputId}">
                    <div class='slider-button' id="slider-button-${outputId}"></div>
                </div>
            </div>`;

            // å°†å…¶ä»– children å…ƒç´ æ·»åŠ åˆ° outputParent å…ƒç´ ä¸­
            children.forEach(child => {
                outputParent.appendChild(child);
            });

            /* before after image slider */
            const slider = document.getElementById(`slider-${outputId}`);
            const beforeImage = document.getElementById(`before-${outputId}`);
            const sliderButton = document.getElementById(`slider-button-${outputId}`);


            slider.addEventListener('input', (e) => {
                const sliderPos = e.target.value;
                // æ›´æ–°å‰æ™¯å›¾åƒçš„å®½åº¦
                beforeImage.style.width = `calc(${sliderPos}% - 1px)`;
                // æ›´æ–°æ»‘åŠ¨æŒ‰é’®çš„ä½ç½®
                sliderButton.style.left = `calc(${sliderPos}% - 12px)`;
            });
        }

        function displayImage(outputId, imageUrl) {
            const output = document.getElementById(outputId);
            const outputParent = output.parentNode;
            // ä¿ç•™é™¤ id={outputId} å…ƒç´ ä»¥å¤–çš„æ‰€æœ‰å­å…ƒç´ 
            const children = Array.from(outputParent.children).filter(child => child.id!== outputId);
            // ç¼–è¾‘ output å…ƒç´ 
            const i = outputId.split('-')[1];
            outputParent.innerHTML = `
            <img src="${imageUrl}" alt="å¢å¼ºå›¾åƒ${i}" id="${outputId}">`;

            // å°†å…¶ä»– children å…ƒç´ æ·»åŠ åˆ° outputParent å…ƒç´ ä¸­
            children.forEach(child => {
                outputParent.appendChild(child);
            });
        }

        function uploadRating() {
            // è·å–å½“å‰ç½‘é¡µçš„ url å’Œ user_id
            const url = window.location.href;
            const urlParams = new URLSearchParams(url.split('?')[1]);
            const user_id = urlParams.get('user_id');

            // è·å–æ‰€æœ‰ id å’Œ rating å€¼
            const allImages = document.querySelectorAll('.image-box');
            let groups = [];
            let ratings = [];
            const id = allImages[0].getAttribute('imageid');
            for (let i = 1; i < allImages.length; i++) {
                const group = allImages[i].getAttribute('imagegroup');
                // æ•° highlight æ˜Ÿæ˜Ÿçš„ä¸ªæ•°
                const stars = allImages[i].querySelectorAll('.star.highlight');
                const rating = stars.length;
                groups.push(group);
                ratings.push(rating);
            }

            // è·å–æ‰€æœ‰è¯„åˆ†çš„ group å’Œè¯„åˆ†å€¼
            const data = {
                'id': id,
            }
            for (let i = 0; i < groups.length; i++) {
                data[groups[i]] = ratings[i];
            }

            let formData = new FormData();
            for (let key in data) {
                formData.append(`${key}`, data[key]);
            }

            requestAndUpdate(formData, user_id);
        }

        // å‘é€è¯·æ±‚å¹¶æ›´æ–°é¡µé¢
        function requestAndUpdate(formData, user_id) {
            const text = document.getElementById('text');
            text.innerHTML = 'è¯·æ±‚å›¾åƒä¸­...';

            // å‘é€è¯·æ±‚åˆ°åç«¯
            fetch(`/interface/rating?user_id=${user_id}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json()) // è§£æä¸º JSON
                .then(data => {
                    text.innerHTML = '';
                    if (data.next_id) {
                        if (data.next_id === "201-None") {
                            alert('æ‰€æœ‰å›¾åƒå·²æäº¤ï¼');
                        }
                        else if (data.next_id === "401-DataNotFound") {
                            alert('å›¾åƒæ•°æ®åº“ä¸¢å¤±ï¼');
                        } else {
                            replaceImages(data.next_id);
                        }
                    } else {
                        alert('è·å– next_id å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    }
                })
                .catch(error => {
                    text.innerHTML = '';
                    alert(`æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯ï¼š${error}`);
                });
        }

        window.onload = function() {
            updateMainContainer();
            confirmImage("201-None", "None");

            changeTitle('User-Study ç•Œé¢');

            // æ­£æ–¹ä½“åŠ¨ç”»
            cubeInit();
        }
    </script>
</head>
<body>
    <h1 id="interface-title">User-Study ç•Œé¢</h1>

    <div class="container" id="main-container">
        <!-- ä¸Šæ–¹çš„ä¸€ä¸ªä½å…‰å›¾åƒæ¡† -->
        <div class="panel">
            <h2 class="panel-title">ä½å…‰å›¾åƒ</h2>
            <div class="image-box" id="input-box" style="display: inline-block;">
                <img src="/images/input/00700.png" alt="Input Image">
            </div>
        </div>

        <!-- ä¸‹æ–¹çš„å¤šä¸ªå¢å¼ºå›¾åƒæ¡† -->
        <div class="panel">
            <h2 class="panel-title">å¢å¼ºå›¾åƒ</h2>
            <div class="image-row" id="output-row">
                <div class="image-box">
                    <img src="/images/FourLLIE/00700.png" alt="å¢å¼ºå›¾åƒ1" id="output-1">
                    <div class="star-rating" id="star-rating-1">
                        <span class="star" onclick="setStarRating(1, 1)">â˜…</span>
                        <span class="star" onclick="setStarRating(1, 2)">â˜…</span>
                        <span class="star" onclick="setStarRating(1, 3)">â˜…</span>
                        <span class="star" onclick="setStarRating(1, 4)">â˜…</span>
                        <span class="star" onclick="setStarRating(1, 5)">â˜…</span>
                    </div>
                </div>
                <div class="image-box">
                    <img src="/images/LightenDiffusion/00700.png" alt="å¢å¼ºå›¾åƒ2" id="output-2">
                    <div class="star-rating" id="star-rating-2">
                        <span class="star" onclick="setStarRating(2, 1)">â˜…</span>
                        <span class="star" onclick="setStarRating(2, 2)">â˜…</span>
                        <span class="star" onclick="setStarRating(2, 3)">â˜…</span>
                        <span class="star" onclick="setStarRating(2, 4)">â˜…</span>
                        <span class="star" onclick="setStarRating(2, 5)">â˜…</span>
                    </div>
                </div>
                <div class="image-box">
                    <img src="/images/SNR-Net/00700.png" alt="å¢å¼ºå›¾åƒ3" id="output-3">
                    <div class="star-rating" id="star-rating-3">
                        <span class="star" onclick="setStarRating(3, 1)">â˜…</span>
                        <span class="star" onclick="setStarRating(3, 2)">â˜…</span>
                        <span class="star" onclick="setStarRating(3, 3)">â˜…</span>
                        <span class="star" onclick="setStarRating(3, 4)">â˜…</span>
                        <span class="star" onclick="setStarRating(3, 5)">â˜…</span>
                    </div>
                </div>
                <div class="image-box">
                    <img src="/images/LCNet/00700.png" alt="å¢å¼ºå›¾åƒ4" id="output-4">
                    <div class="star-rating" id="star-rating-4">
                        <span class="star" onclick="setStarRating(4, 1)">â˜…</span>
                        <span class="star" onclick="setStarRating(4, 2)">â˜…</span>
                        <span class="star" onclick="setStarRating(4, 3)">â˜…</span>
                        <span class="star" onclick="setStarRating(4, 4)">â˜…</span>
                        <span class="star" onclick="setStarRating(4, 5)">â˜…</span>
                    </div>
                </div>
                <div class="image-box">
                    <img src="/images/Retinexformer/00700.png" alt="å¢å¼ºå›¾åƒ5" id="output-5">
                    <div class="star-rating" id="star-rating-5">
                        <span class="star" onclick="setStarRating(5, 1)">â˜…</span>
                        <span class="star" onclick="setStarRating(5, 2)">â˜…</span>
                        <span class="star" onclick="setStarRating(5, 3)">â˜…</span>
                        <span class="star" onclick="setStarRating(5, 4)">â˜…</span>
                        <span class="star" onclick="setStarRating(5, 5)">â˜…</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tip"><span class="tip-icon">ğŸ’¡</span>å·¦é”®ç‚¹å‡»å›¾åƒæ”¾å¤§ï¼Œå³é”®ç‚¹å‡»å›¾åƒå¯¹æ¯”</div>
        <button onclick="uploadRating()">ä¸Šä¼ ç»“æœ</button>
        <div id="text"></div>

        <div class="outerDiv">
            <img id="imageViewer" src="/images/Retinexformer/00700.png" alt="imageViewer"/>
            <!-- tip ä½äºæœ€åº•éƒ¨ -->
            <div class="imageViewerTip"><span class="tip-icon">ğŸ’¡</span>ä¸­é”®æŒ‰ä½å¹¶æ‹–åŠ¨ç§»åŠ¨å›¾åƒï¼Œæ»šè½®æ»šåŠ¨ç¼©æ”¾å›¾ç‰‡</div>
        </div>
    </div>
</body>
</html>
